<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALPR Surveillance - Real-time License Plate Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated background */
        .background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a0a 100%);
        }

        .floating-orbs {
            position: absolute;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.4;
            animation: float 20s infinite ease-in-out;
        }

        .orb1 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            top: -150px;
            left: -150px;
            animation-delay: 0s;
        }

        .orb2 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            bottom: -200px;
            right: -200px;
            animation-delay: 5s;
        }

        .orb3 {
            width: 250px;
            height: 250px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) rotate(0deg);
            }
            33% {
                transform: translate(30px, -30px) rotate(120deg);
            }
            66% {
                transform: translate(-20px, 20px) rotate(240deg);
            }
        }

        /* Navigation */
        nav {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav-container {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            list-style: none;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: color 0.3s ease;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: #ffffff;
        }

        /* Main container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .control-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: rgba(245, 87, 108, 0.2);
            color: #f5576c;
            border: 1px solid rgba(245, 87, 108, 0.3);
        }

        .btn-danger:hover {
            background: rgba(245, 87, 108, 0.3);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Surveillance layout */
        .surveillance-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        /* Video section */
        .video-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            height: fit-content;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 1.5rem;
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-stream {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-placeholder {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
        }

        .video-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .video-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .video-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .video-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4facfe;
            margin-bottom: 0.25rem;
        }

        .video-stat-label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Detection feed */
        .detection-feed {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .feed-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .feed-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .feed-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4facfe;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .detection-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .detection-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1rem;
            transition: all 0.3s ease;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .detection-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(-5px);
        }

        .detection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .detection-plate {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            color: #ffffff;
        }

        .detection-time {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .detection-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .detection-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .detail-label {
            color: rgba(255, 255, 255, 0.5);
        }

        .detail-value {
            color: #ffffff;
            font-weight: 600;
        }

        .confidence-high {
            color: #4facfe;
        }

        .confidence-medium {
            color: #fa709a;
        }

        .confidence-low {
            color: #f5576c;
        }

        /* Alerts section */
        .alerts-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .alerts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .alerts-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffffff;
        }

        .alert-count {
            background: rgba(245, 87, 108, 0.2);
            color: #f5576c;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .alerts-grid {
            display: grid;
            gap: 1rem;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: center;
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(-5px);
        }

        .alert-icon {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .alert-icon.critical {
            background: rgba(245, 87, 108, 0.2);
            color: #f5576c;
        }

        .alert-icon.high {
            background: rgba(250, 112, 154, 0.2);
            color: #fa709a;
        }

        .alert-icon.medium {
            background: rgba(254, 225, 64, 0.2);
            color: #fee140;
        }

        .alert-content h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.25rem;
        }

        .alert-message {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .alert-time {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Sessions section */
        .sessions-section {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 2rem;
        }

        .sessions-header {
            margin-bottom: 1.5rem;
        }

        .sessions-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .sessions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sessions-table th {
            text-align: left;
            padding: 1rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sessions-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .sessions-table tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        .session-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .session-status.active {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
        }

        .session-status.completed {
            background: rgba(48, 207, 208, 0.2);
            color: #30cfd0;
        }

        /* Camera controls */
        .camera-controls {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .camera-select {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-size: 1rem;
        }

        .camera-select option {
            background: #1a1a2e;
        }

        .camera-status {
            font-size: 0.9rem;
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            margin-left: 0.5rem;
        }

        .camera-status.detecting {
            color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }

        .camera-status.success {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }

        .camera-status.error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        /* Loading and empty states */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .surveillance-grid {
                grid-template-columns: 1fr;
            }
            
            .detection-feed {
                height: auto;
                max-height: 500px;
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-buttons {
                width: 100%;
            }
            
            .btn {
                flex: 1;
                justify-content: center;
            }
            
            .video-stats {
                grid-template-columns: 1fr;
            }
            
            .detection-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="background">
        <div class="floating-orbs">
            <div class="orb orb1"></div>
            <div class="orb orb2"></div>
            <div class="orb orb3"></div>
        </div>
    </div>

    <nav>
        <div class="nav-container">
            <a href="/ui/navigation.html" class="logo">ALPR System</a>
            <ul class="nav-links">
                <li><a href="/ui/navigation.html">Home</a></li>
                <li><a href="/ui/">Upload</a></li>
                <li><a href="/ui/analytics.html">Analytics</a></li>
                <li><a href="/ui/surveillance.html">Surveillance</a></li>
                <li><a href="/ui/history.html">History</a></li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>Live Surveillance</h1>
            <div class="control-buttons">
                <button class="btn btn-primary" id="start-btn" onclick="startSurveillance()">
                    <span>▶</span> Start Surveillance
                </button>
                <button class="btn btn-danger" id="stop-btn" onclick="stopSurveillance()" disabled>
                    <span>■</span> Stop
                </button>
            </div>
        </div>

        <div class="surveillance-grid">
            <div class="video-section">
                <div class="camera-controls">
                    <select class="camera-select" id="camera-select">
                        <option value="0">Default Camera</option>
                        <option value="browser_stream">Browser Camera</option>
                    </select>
                    <button class="btn btn-primary" onclick="detectCameras()">
                        Detect Cameras
                    </button>
                    <button class="btn btn-secondary" onclick="refreshCameras()">
                        Refresh
                    </button>
                    <span id="camera-status" class="camera-status"></span>
                </div>

                <div class="video-container">
                    <div class="video-placeholder" id="video-placeholder">
                        <i></i>
                        <p>Camera feed will appear here</p>
                    </div>
                    <video class="video-stream" id="video-stream" style="display: none;" autoplay muted></video>
                </div>

                <div class="video-stats">
                    <div class="video-stat">
                        <div class="video-stat-value" id="fps-value">0</div>
                        <div class="video-stat-label">FPS</div>
                    </div>
                    <div class="video-stat">
                        <div class="video-stat-value" id="vehicles-tracked">0</div>
                        <div class="video-stat-label">Vehicles Tracked</div>
                    </div>
                    <div class="video-stat">
                        <div class="video-stat-value" id="active-vehicles">0</div>
                        <div class="video-stat-label">Active Now</div>
                    </div>
                </div>
            </div>

            <div class="detection-feed">
                <div class="feed-header">
                    <h2>Live Detections</h2>
                    <div class="feed-status">
                        <span class="status-dot"></span>
                        <span id="feed-status">Waiting...</span>
                    </div>
                </div>
                <div class="detection-list" id="detection-list">
                    <div class="empty-state">
                        <i></i>
                        <p>No detections yet</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="alerts-section" id="alerts-section" style="display: none;">
            <div class="alerts-header">
                <h2>Active Alerts</h2>
                <span class="alert-count" id="alert-count">0</span>
            </div>
            <div class="alerts-grid" id="alerts-grid"></div>
        </div>

        <div class="sessions-section">
            <div class="sessions-header">
                <h2>Recent Sessions</h2>
                <p style="color: rgba(255, 255, 255, 0.6);">Previous surveillance sessions</p>
            </div>
            <table class="sessions-table">
                <thead>
                    <tr>
                        <th>Start Time</th>
                        <th>Duration</th>
                        <th>Detections</th>
                        <th>Vehicles</th>
                        <th>Alerts</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="sessions-tbody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: rgba(255, 255, 255, 0.5);">
                            Loading sessions...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let ws = null;
        let isStreaming = false;
        let detectionCount = 0;
        let alertCount = 0;
        let browserStream = null;
        let captureInterval = null;

        // WebSocket connection
        function connectWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws/surveillance`);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('feed-status').textContent = 'Connected';
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('feed-status').textContent = 'Connection error';
            };
            
            ws.onclose = () => {
                console.log('WebSocket disconnected');
                document.getElementById('feed-status').textContent = 'Disconnected';
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'detection') {
                updateDetections(data.data);
            } else if (data.type === 'anomaly_alert') {
                addAlert(data);
            } else if (data.type === 'stats_update') {
                updateStats(data.data);
            }
        }

        function updateDetections(data) {
            const detectionList = document.getElementById('detection-list');
            
            // Remove empty state if exists
            const emptyState = detectionList.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
            
            if (data.detections && data.detections.length > 0) {
                data.detections.forEach(detection => {
                    const confidenceClass = detection.confidence > 0.8 ? 'confidence-high' : 
                                          detection.confidence > 0.6 ? 'confidence-medium' : 'confidence-low';
                    
                    const detectionItem = document.createElement('div');
                    detectionItem.className = 'detection-item';
                    detectionItem.innerHTML = `
                        <div class="detection-header">
                            <div class="detection-plate">${detection.plate_text}</div>
                            <div class="detection-time">Just now</div>
                        </div>
                        <div class="detection-details">
                            <div class="detection-detail">
                                <span class="detail-label">State:</span>
                                <span class="detail-value">${detection.state || 'Unknown'}</span>
                            </div>
                            <div class="detection-detail">
                                <span class="detail-label">Confidence:</span>
                                <span class="detail-value ${confidenceClass}">${Math.round(detection.confidence * 100)}%</span>
                            </div>
                        </div>
                    `;
                    
                    detectionList.insertBefore(detectionItem, detectionList.firstChild);
                    
                    // Keep only last 20 detections
                    while (detectionList.children.length > 20) {
                        detectionList.removeChild(detectionList.lastChild);
                    }
                    
                    detectionCount++;
                });
            }
            
            // Update stats if available
            if (data.tracking_stats) {
                updateStats(data);
            }
        }

        function updateStats(data) {
            if (data.fps !== undefined) {
                document.getElementById('fps-value').textContent = Math.round(data.fps);
            }
            
            if (data.tracking_stats) {
                document.getElementById('vehicles-tracked').textContent = data.tracking_stats.total_vehicles_tracked || 0;
                document.getElementById('active-vehicles').textContent = data.tracking_stats.active_vehicles || 0;
            }
        }

        function addAlert(alert) {
            const alertsSection = document.getElementById('alerts-section');
            alertsSection.style.display = 'block';
            
            alertCount++;
            document.getElementById('alert-count').textContent = alertCount;
            
            const alertsGrid = document.getElementById('alerts-grid');
            
            const iconClass = alert.severity === 'critical' ? 'critical' : 
                            alert.severity === 'high' ? 'high' : 'medium';
            
            const alertItem = document.createElement('div');
            alertItem.className = 'alert-item';
            alertItem.innerHTML = `
                <div class="alert-icon ${iconClass}">⚠️</div>
                <div class="alert-content">
                    <h3>${alert.data.type}</h3>
                    <p class="alert-message">${alert.data.message}</p>
                </div>
                <div class="alert-time">Just now</div>
            `;
            
            alertsGrid.insertBefore(alertItem, alertsGrid.firstChild);
            
            // Keep only last 10 alerts
            while (alertsGrid.children.length > 10) {
                alertsGrid.removeChild(alertsGrid.lastChild);
            }
        }

        async function startSurveillance() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const cameraSelect = document.getElementById('camera-select');
            const videoSource = cameraSelect.value;
            
            startBtn.disabled = true;
            stopBtn.disabled = false;
            
            // Connect WebSocket if not connected
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                connectWebSocket();
            }
            
            try {
                // Start surveillance based on source
                if (videoSource === 'browser_stream') {
                    await startBrowserStream();
                } else {
                    // Start server-side camera
                    const response = await fetch('/api/v1/surveillance/start', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ video_source: videoSource })
                    });
                    
                    if (response.ok) {
                        isStreaming = true;
                        document.getElementById('feed-status').textContent = 'Live';
                        
                        // Show video stream
                        document.getElementById('video-placeholder').style.display = 'none';
                        const videoElement = document.getElementById('video-stream');
                        videoElement.style.display = 'block';
                        videoElement.src = '/api/v1/surveillance/video-feed';
                    }
                }
            } catch (error) {
                console.error('Error starting surveillance:', error);
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        }

        async function startBrowserStream() {
            try {
                // Get camera access
                browserStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });
                
                // Show video in UI
                const videoElement = document.getElementById('video-stream');
                videoElement.srcObject = browserStream;
                videoElement.style.display = 'block';
                document.getElementById('video-placeholder').style.display = 'none';
                
                // Start server processing
                const response = await fetch('/api/v1/surveillance/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ video_source: 'browser_stream' })
                });
                
                if (response.ok) {
                    isStreaming = true;
                    document.getElementById('feed-status').textContent = 'Live (Browser)';
                    
                    // Start capturing frames
                    startFrameCapture();
                }
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Could not access camera. Please ensure camera permissions are granted.');
            }
        }

        function startFrameCapture() {
            const videoElement = document.getElementById('video-stream');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            let frameId = 0;
            
            captureInterval = setInterval(async () => {
                if (!isStreaming || !browserStream) return;
                
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                ctx.drawImage(videoElement, 0, 0);
                
                canvas.toBlob(async (blob) => {
                    if (!blob) return;
                    
                    const formData = new FormData();
                    formData.append('frame', blob, 'frame.jpg');
                    formData.append('frame_id', frameId++);
                    
                    try {
                        await fetch('/api/v1/surveillance/process-frame', {
                            method: 'POST',
                            body: formData
                        });
                    } catch (error) {
                        console.error('Error sending frame:', error);
                    }
                }, 'image/jpeg', 0.8);
            }, 200); // Send 5 frames per second
        }

        async function stopSurveillance() {
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            try {
                // Stop frame capture if using browser stream
                if (captureInterval) {
                    clearInterval(captureInterval);
                    captureInterval = null;
                }
                
                // Stop browser stream
                if (browserStream) {
                    browserStream.getTracks().forEach(track => track.stop());
                    browserStream = null;
                    
                    const videoElement = document.getElementById('video-stream');
                    videoElement.srcObject = null;
                }
                
                // Stop server surveillance
                await fetch('/api/v1/surveillance/stop', {
                    method: 'POST'
                });
                
                isStreaming = false;
                document.getElementById('feed-status').textContent = 'Stopped';
                
                // Hide video, show placeholder
                document.getElementById('video-stream').style.display = 'none';
                document.getElementById('video-placeholder').style.display = 'block';
                
                // Load sessions to update with completed session
                loadSessions();
            } catch (error) {
                console.error('Error stopping surveillance:', error);
            }
        }

        async function loadSessions() {
            try {
                const response = await fetch('/api/v1/surveillance/sessions');
                const data = await response.json();
                
                const tbody = document.getElementById('sessions-tbody');
                
                if (data.sessions && data.sessions.length > 0) {
                    tbody.innerHTML = data.sessions.slice(0, 10).map(session => {
                        const duration = session.duration_minutes ? 
                            `${Math.round(session.duration_minutes)} min` : 'Active';
                        
                        return `
                            <tr>
                                <td>${new Date(session.start_time).toLocaleString()}</td>
                                <td>${duration}</td>
                                <td>${session.total_detections || 0}</td>
                                <td>${session.total_vehicles || 0}</td>
                                <td>${session.total_alerts || 0}</td>
                                <td>
                                    <span class="session-status ${session.status}">
                                        ${session.status}
                                    </span>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: rgba(255, 255, 255, 0.5);">No sessions found</td></tr>';
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
            }
        }

        async function refreshCameras() {
            console.log('Refreshing cameras...');
            
            try {
                // Stop current surveillance if running
                await fetch('/api/v1/surveillance/stop', { method: 'POST' });
                
                // Clear current video
                const video = document.getElementById('surveillance-video');
                const placeholder = document.getElementById('video-placeholder');
                
                if (video && video.srcObject) {
                    video.srcObject = null;
                }
                
                if (placeholder) {
                    placeholder.style.display = 'block';
                }
                
                // Reconnect WebSocket
                if (ws) {
                    ws.close();
                }
                connectWebSocket();
                
                // Refresh detection list
                loadSessions();
                
                console.log('Camera refresh completed');
                
            } catch (error) {
                console.error('Error refreshing cameras:', error);
            }
        }
        
        async function detectCameras() {
            console.log('Detecting cameras...');
            const statusEl = document.getElementById('camera-status');
            const selectEl = document.getElementById('camera-select');
            
            try {
                statusEl.textContent = 'Detecting cameras...';
                statusEl.className = 'camera-status detecting';
                
                const response = await fetch('/api/v1/cameras/detect');
                const data = await response.json();
                
                if (response.ok && data.cameras) {
                    // Clear existing options except browser camera
                    selectEl.innerHTML = '<option value="browser_stream">Browser Camera</option>';
                    
                    // Add detected cameras
                    data.cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.index;
                        
                        let name = camera.name;
                        if (camera.resolution) {
                            name += ` (${camera.resolution})`;
                        }
                        if (!camera.is_working) {
                            name += ' [Not Working]';
                        }
                        
                        option.textContent = name;
                        option.disabled = !camera.is_working;
                        selectEl.appendChild(option);
                    });
                    
                    statusEl.textContent = `Found ${data.total_detected} cameras (${data.working_cameras} working)`;
                    statusEl.className = 'camera-status success';
                    
                    // Auto-select best working camera
                    if (data.working_cameras > 0) {
                        const workingCameras = data.cameras.filter(c => c.is_working);
                        if (workingCameras.length > 0) {
                            // Select the first working camera that's not the default
                            const bestCamera = workingCameras.find(c => c.index !== 0) || workingCameras[0];
                            selectEl.value = bestCamera.index;
                        }
                    }
                    
                    console.log('Camera detection completed:', data);
                    
                } else {
                    throw new Error(data.error || 'Failed to detect cameras');
                }
                
            } catch (error) {
                console.error('Error detecting cameras:', error);
                statusEl.textContent = 'Error detecting cameras';
                statusEl.className = 'camera-status error';
            }
        }
        
        async function testCamera(cameraIndex) {
            console.log(`Testing camera ${cameraIndex}...`);
            
            try {
                const response = await fetch(`/api/v1/cameras/${cameraIndex}/test`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (response.ok && data.working) {
                    console.log(`Camera ${cameraIndex} is working:`, data);
                    return true;
                } else {
                    console.warn(`Camera ${cameraIndex} test failed:`, data.error);
                    return false;
                }
                
            } catch (error) {
                console.error(`Error testing camera ${cameraIndex}:`, error);
                return false;
            }
        }

        // Initialize
        connectWebSocket();
        loadSessions();
        
        // Refresh sessions periodically
        setInterval(loadSessions, 30000);
    </script>
</body>
</html>